<template>
    <style>

        .row-aula > div > input{
            width: 150px;
        }

        .row-aula > div{
            border-bottom: solid 1px #b5b4b4;
        }

        @media all and (max-width : 768px) {
            .row-aula > div > input{
                width: unset;
            }
        }

    </style>
  
    <fieldset>
        <legend id="lgd-aluno"></legend>
        <div class="row-aula"></div>
    </fieldset>


</template>
<script>

    const pageData = main_data.fin_baixa_aula.data
    const pageFunc = main_data.fin_baixa_aula.func
    const pageScreen = document.querySelector('#card-fin_baixa_aula')
    pageData.aula_aberta = []

console.log(pageData)    

    pageFunc.pageStart = ()=>{

        pageScreen.querySelector('#lgd-aluno').innerHTML = pageData.aluno

        if(pageData.org=='aula'){
            const obj = new Object
                obj.data_hora = pageData.data_hora
                obj.data = pageData.DATA
                obj.hora = pageData.HORARIO
                obj.valor = parseFloat(pageData.valor)
                obj.pg = parseInt(pageData.pg)
            pageData.aula_aberta.push(obj)
        }else{
            const aulas = pageData.aulas.split(',')
            for(let i=0; i<aulas.length; i++){
                const hora_val = aulas[i].split('|')
                const obj = new Object
                    obj.data_hora = hora_val[0]
                    obj.data = hora_val[0].viewDate()
                    obj.hora = hora_val[0].time()
                    obj.valor = parseFloat(hora_val[1])
                    obj.pg = 0
                pageData.aula_aberta.push(obj)
            }
        }

        fillAula()
    }

    function fillAula(){
        const tbl = pageScreen.querySelector('.row-aula')
        tbl.innerHTML = ''
        for(let i=0; i<pageData.aula_aberta.length; i++){
            const row = document.createElement('div')
            row.className = 'aula inline'
            row.aula = i

            const dt = document.createElement('label')
//            dt.innerHTML = pageData.aula_aberta[i].data
            dt.className = 'row-title'
            dt.innerHTML = ` Aula dia ${pageData.aula_aberta[i].data} as ${pageData.aula_aberta[i].hora} valor R$${pageData.aula_aberta[i].valor.toFixed(2)}`
            row.appendChild(dt)
/*
            const hr = document.createElement('label')
            hr.innerHTML = pageData.aula_aberta[i].hora
            row.appendChild(hr)

            const val = document.createElement('label')
            val.innerHTML = 'R$'+pageData.aula_aberta[i].valor.toFixed(2)
            row.appendChild(val)
*/

            const baixa = document.createElement('button')
            baixa.innerHTML = 'Baixar Aula'
            baixa.addEventListener('click',(e)=>{
                const index = parseInt(e.target.parentNode.aula)
                console.log(pageData.aula_aberta[index])
            })
            row.appendChild(baixa)

            tbl.appendChild(row)
        }
    }

/*
    
    function setAula(obj,del=0){
        const params = new Object;
            params.id_aluno = obj.id_aluno
            params.id_aula = pageScreen.querySelector('#cmbTipos').value
            params.data_hora = pageData.date+' '+pageData.time+':00'
            params.val = obj.valor
            params.pg = 0
            params.del = del          
        const myPromisse = queryDB(params,'AGD-3');
        return myPromisse.then((resolve)=>{
            setLog(`Aula ${del ? 'Deletada' : 'Efetuada'} ${obj.aluno} dia ${pageData.date.viewDate()} as ${pageData.time}`)
            main_data.agd_aula.func.getAulas()
            closeModal('agd_view_aula')
        })
    }

    function addRow(data){
        const alunos = pageScreen.querySelector('.row-aluno')
        if(alunos.querySelector(`.aln-${data.id_aluno}`)===null){
            const tipo_aula = pageScreen.querySelector('#cmbTipos')
            const row = document.createElement('div')
            row.className = `aluno inline aln-${data.id_aluno}`
            row.data = data
            
            const lbl = document.createElement('label')
            lbl.innerHTML = data.aluno
            lbl.for = 'aluno-'+data.id_aluno
            row.appendChild(lbl)
            
            const edt_btn = document.createElement('div')
            edt_btn.className = 'edtbtn'

            const valor = document.createElement('input')
            valor.id = 'aluno-'+data.id_aluno
            valor.className = 'val-aluno'
            valor.addEventListener('keyup',(e)=>{valFloat(e.target)})
            valor.addEventListener('focus',(e)=>{e.target.select()})
            valor.inputMode = 'decimal'
            valor.value = parseFloat(tipo_aula.options[tipo_aula.selectedIndex].data.valor).toFixed(2)
            edt_btn.appendChild(valor)

            const btn = document.createElement('button')
            btn.className = 'btn-round'
            btn.innerHTML = '<span class="mdi mdi-eraser"></span>'
            btn.addEventListener('click',(e)=>{
                if(confirm('Remover este aluno desta aula?')){
                    const aula = e.target.parentNode.parentNode.parentNode.data
                    e.target.parentNode.parentNode.parentNode.remove()
                     setAula(aula,1)                    
                }
            })
            edt_btn.appendChild(btn)
            row.appendChild(edt_btn)
            alunos.appendChild(row)
        }
    }



    pageFunc.fillAula = ()=>{

        const cmb = pageScreen.querySelector('#cmbTipos')
        cmb.innerHTML = ''

        const myPromisse = queryDB({},'ADM-4');
        return myPromisse.then((resolve)=>{
            const json = JSON.parse(resolve)
            for(let i=0; i<json.length;i++){               
                const opt = document.createElement('option')
                opt.value = json[i].id
                opt.innerHTML = json[i].descricao+' - '+json[i].clube
                opt.data = json[i]
                cmb.appendChild(opt)
            }
        });
    }

    pageFunc.buscaAluno = (data)=>{
        data.aluno = data.nome
        data.id_aluno = data.id
        addRow(data)
    }

    pageScreen.querySelector('#btnBuscaAluno').addEventListener('click',()=>{
        closeModal('adm_aluno')
        openHTML('adm_aluno.html','pop-up','Selecione o Aluno',{'org':'agd_view_aula'})
    })

    pageScreen.querySelector('#btnSave').addEventListener('click',()=>{
        const alunos = pageScreen.querySelectorAll('.aluno')
        for(let i=0; i<alunos.length; i++){
            alunos[i].data.valor = alunos[i].querySelector(`#aluno-${alunos[i].data.id_aluno}`).value            
            setAula(alunos[i].data)
            .then((response)=>{
                
//                closeModal('agd_view_aula')
            })

        }
    })


    function getValor(sel){
        const valor = parseFloat(sel.options[sel.selectedIndex].data.valor).toFixed(2)
        const alunos = pageScreen.querySelectorAll('.val-aluno')
        for(let i=0; i<alunos.length; i++){
            alunos[i].value = valor
        }
    }

    pageScreen.querySelector('#cmbTipos').addEventListener('change',(e)=>{
        getValor(e.target)
    })
*/
    pageFunc.pageStart()

</script>